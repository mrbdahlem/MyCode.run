<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Running Java...</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="javaConsole.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src = "https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.19.0/css/xterm.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/xterm@4.19.0/lib/xterm.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.min.js"></script>

        <script src="https://cjrtnc.leaningtech.com/3.0rc2/cj3loader.js"></script>
        <!-- <script src="https://cjrtnc.leaningtech.com/latest/loader.js"></script> -->
    </head>
    <body>
        <ul class="nav nav-tabs" id="tabMenu">
            <li class="active"><a id="terminalButton">Terminal</a></li>
            <li><a id="graphicsButton">Graphics Display</a></li>
        </ul>
        
        <div class="tab-content" id="displayTabs">
            <div id="term" style="z-index: 10000;">
                <div id="terminal"></div>
            </div>
            <div id="hider" style="z-index: 9999; background-color: #000;"></div>
            <div id="graphics"  style="z-index: 100;">
                <div id="graphicsDisplay" style="border: 1px solid black;"></div>
            </div>
        </div>
        <script>
const urlParams = new URLSearchParams(window.location.search);
let useGraphics = urlParams.has('graphics');

const $graphicsButton = $('#graphicsButton');

if (!useGraphics) {
    $graphicsButton.hide();
    $('#graphics').hide();
}      
      
$('#terminalButton').click(()=>{
    $('.nav-tabs li').removeClass('active');
    $('#terminalButton').parent().addClass('active');
    $('#term').css('z-index', 10000);
    $('#hider').css('z-index', 9999);
});
$graphicsButton.click(()=>{
    $('.nav-tabs li').removeClass('active');
    $('#graphicsButton').parent().addClass('active');
    $('#term').css('z-index', 0);
    $('#hider').css('z-index', 99); 
})
            
let textPreloadFileList=[];
let graphicsPreloadFileList=[];

let preloadFileList = useGraphics ? graphicsPreloadFileList : textPreloadFileList;

const term = new Terminal();
term.open(document.getElementById('terminal'));
term.setOption('convertEol', true);
term.setOption('altClickMovesCursor', false);
term.onData(data=>userTyped(data));

const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
$(window).resize(()=>fitAddon.fit());
fitAddon.fit();

term.write("Initializing...\n");

// Initialize cheerpj and preload resource files
// const preload = (async () => {
//     await cheerpjInit();
//     const lib = await cheerpjRunLibrary("/app/example.jar");
//     // ...
// )();
const preload = cheerpjInit({preloadResources:preloadFileList});

if (useGraphics) {
    cheerpjCreateDisplay(-1,-1, document.getElementById("graphicsDisplay"));
}

let compileData;
let controller;
let stdInPush;

async function compileJava(compileUnit) {
    compileData = compileUnit;
    
    preload.then(() => {
        // add cheerpj specific paths to the compile unit
        compileUnit.tempDir = "/files/" + "tmp" + Math.floor(Math.random() * 32768) + "/";
        compileUnit.sourceDir = "/str/";
        compileUnit.filename = compileUnit.sourceDir + "compile.unit";
        
        // Save the compile unit to a file so that it can be accessed by the compiler
        cheerpOSAddStringFile(compileUnit.filename, JSON.stringify(compileUnit));
        
        // Need to do this with runlib?
        compileUnit.classpath =
                "/app/cheerpJ/CheerpJRunner.jar:"
                        + "/app/cheerpJ/tools.jar:"
                        + compileUnit.tempDir;
        
        cheerpjRunMain("run.mycode.cheerpjrunner.Runner", compileUnit.classpath,
            compileUnit.filename);

        console.log("here!");
    });
}

function startCompileTask(controller) {
    let sourceFiles = [];
    
    sourceFiles.push(compileData.tempDir);
    
    compileData.compile.sourceFiles.forEach(f=>{
        sourceFiles.push(compileData.tempDir + f.name);
    });

    cheerpjRunMain("run.mycode.cheerpjrunner.tasks.CompileTask", 
        compileData.classpath,...sourceFiles)
            .then((ret) => {
                if (ret === 0) {
                    cjResolveCall("run.mycode.cheerpjrunner.io.CJInputStream", 
                            "stdInPush", ["java.lang.String"])
                                    .then((method)=>{stdInPush = method;});
                    cjCall(controller, "compilationSuccess");
            
                    // TODO: If graphics mode is enabled, swap to graphics output
                    if (useGraphics) {
                        $("#graphicsButton").click();
                    }
                }
                else {
                    cjCall(controller, "compilationFailure");
                }
            });
}


function javaOutput(str, outputStream) {
    switch(outputStream.toLowerCase()) {
        case "err":
            outputStream = "err";
            break;
            
        case "std":
        default:
            outputStream = "stdout";
            break;
    }
    term.write(str);
}

function userTyped(s) {
    // Display each character the user typed on the terminal
    Array.from(s).forEach((c) => {
        switch(c.charCodeAt(0)) {
            case 127: // del
            case 8:   // backspace
                term.write("\b \b");
                break;
            case 13:  // carriage return
                term.write("\n");
                break;
            default:
                term.write(c)// + c.charCodeAt(0) + '\n');
        }
    });
    
    // Send the characters to the runner
    cjCall(stdInPush, s);
}
        </script>
    </body>
</html>
